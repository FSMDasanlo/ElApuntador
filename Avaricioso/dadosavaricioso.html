<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Apuntador - El Avaricioso</title>
  <link rel="stylesheet" href="style_avaricioso.css">
  <script src="../jugadores.js" defer></script>
  <script src="dadosavaricioso.js" defer></script>
  <script src="../voz-navegador.js" defer></script>
  <script src="../componentes-comunes.js" defer></script>
</head>
<body class="juego">

<div class="cabecera-juego">
  <header class="header-juego">
    <div class="titulo">
      <h1 id="nombre-juego">
        <span id="texto-titulo-juego">EL AVARICIOSO</span>
        <button id="btn-ayuda" class="btn-help" title="Ver reglamento">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10" fill="none"/>
            <text x="12" y="17" text-anchor="middle" font-size="14" font-family="Arial" font-weight="bold" stroke="none">i</text>
          </svg>
        </button>
      </h1>
    </div>
  </header>

  <div class="botones-superiores">
      <button class="btn-accion" onclick="location.href='../juegos.html'">‚Üê A Juegos</button>
      <button class="btn-accion" onclick="location.href='../gestion_jugadores.html'">Nombres</button>
      <button class="btn-accion" onclick="limpiarPuntuaciones()">Limpiar</button>      
      <div class="grupo-voz">
        <button id="btn-voz">üé§ Iniciar voz</button>
        <button id="btn-voz-ayuda" title="Ver comandos de voz" class="btn-help" style="background-color: #f1c40f;">i</button>
      </div>
      <button id="btn-detener-voz" class="btn-accion" style="display:none; background-color: #e74c3c;">üõë Detener voz</button>
  </div>
</div>

<hr class="separador">

<div class="opciones-juego">
  <label for="meta-puntos">Meta de Puntos:</label>
  <input type="number" id="meta-puntos" value="5000" min="100" step="100">
  <button id="btn-abrir-dados" class="btn-lanzar-dados-virtual" title="Lanzar dados virtuales">
    <img src="/assets/inicio.png" alt="tirar dados">
  </button>
</div>

<main class="marcador">
  <div class="tabla">
    <table id="tabla-puntos">
      <thead>
        <tr id="fila-totales"></tr>
        <tr id="fila-ranking"></tr>
        <tr id="fila-nombres"></tr>
      </thead>
      <tbody id="cuerpo-tabla"></tbody>
    </table>
  </div>
  <button id="btn-add-row" title="A√±adir fila nueva">+</button>
</main>

<!-- Modal de ayuda del Reglamento -->
<div id="modal-ayuda" class="modal">
  <div class="modal-contenido">
    <span class="cerrar">&times;</span>
    <h2>Reglas de El Avaricioso</h2>
    <p>El objetivo es ser el primer jugador en alcanzar o superar la meta de puntos (normalmente 5000).</p>
    <h4>C√≥mo Jugar:</h4>
    <ul>
      <li>En tu turno, lanzas 6 dados.</li>
      <li>Debes apartar al menos un dado que punt√∫e en cada tirada. Puedes apartar m√°s.</li>
      <li>Puedes plantarte y sumar los puntos de los dados apartados, o puedes volver a tirar los dados restantes para intentar sumar m√°s puntos.</li>
      <li>Si en una tirada no sacas ning√∫n dado que punt√∫e, pierdes todos los puntos acumulados <strong>en ese turno</strong> y pasas el turno al siguiente jugador.</li>
      <li>Si consigues puntuar con los 6 dados, puedes volver a tirar los 6 y seguir acumulando puntos en el mismo turno.</li>
    </ul>
    <h4>Puntuaci√≥n:</h4>
    <ul>
      <li><strong>1:</strong> 100 puntos.</li>
      <li><strong>5:</strong> 50 puntos.</li>
      <li><strong>Tres 1:</strong> 1000 puntos.</li>
      <li><strong>Tres 2, 3, 4, 5 o 6:</strong> El n√∫mero del dado x 100 (ej: tres 4s son 400 puntos).</li>
      <li><strong>Escalera (1-2-3-4-5-6):</strong> 1500 puntos.</li>
    </ul>
  </div>
</div>

<!-- Modal para el Lanzador de Dados Virtual -->
<div id="modal-dados" class="modal">
  <div class="modal-contenido" style="max-width: 400px;">
    <span class="cerrar" id="cerrar-dados">&times;</span>
    <!-- Contenido del lanzador de dados -->
    <div id="lanzador-dados-virtual">
      <h1 id="titulo-lanzador">Turno de...</h1>
      <p>Puntos en este turno: <strong id="puntos-turno-actual">0</strong></p>
      <div id="dados-container">
        <!-- Los 5 dados se generar√°n aqu√≠ con JS -->
      </div>
      <div id="botones-dados-container">
          <button id="boton-tirar-dados">¬°Tirar Dados!</button>
          <button id="boton-plantarse" style="display: none;">Plantarse</button>
      </div>
      <p id="mensaje-lanzador" class="mensaje-lanzador"></p>
    </div>
    <!-- Fin del contenido del lanzador -->
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // La l√≥gica del modal de voz ya est√° en componentes-comunes.js

    // L√≥gica para el modal de ayuda del reglamento
    const modalAyuda = document.getElementById("modal-ayuda");
    const modalDados = document.getElementById("modal-dados");
    const btnAyuda = document.getElementById("btn-ayuda");
    const cerrarAyuda = modalAyuda.querySelector(".cerrar");

    if (btnAyuda && modalAyuda && cerrarAyuda) {
      btnAyuda.addEventListener("click", () => { modalAyuda.style.display = "block"; });
      cerrarAyuda.addEventListener("click", () => { modalAyuda.style.display = "none"; });
      window.addEventListener("click", (e) => {
        if (e.target === modalAyuda) modalAyuda.style.display = "none";
      });
    }

    // --- L√ìGICA PARA EL MODAL DE DADOS VIRTUALES ---
    const btnAbrirDados = document.getElementById("btn-abrir-dados");
    const cerrarDados = document.getElementById("cerrar-dados");

    if (btnAbrirDados && modalDados && cerrarDados) {
      btnAbrirDados.addEventListener("click", () => { 
        modalDados.style.display = "block";
        iniciarTurnoDados(); // Prepara el primer turno al abrir
      });
      cerrarDados.addEventListener("click", () => { modalDados.style.display = "none"; });
      window.addEventListener("click", (e) => {
        if (e.target === modalDados) modalDados.style.display = "none";
      });
    }

    // --- L√ìGICA DEL LANZADOR DE DADOS VIRTUAL (AVARICIOSO) ---
    const caras = {
        "As": { img: "/assets/as.png", puntos: 100 },
        "K": { img: "/assets/k.png", puntos: 50 },
        "Q": { img: "/assets/q.png", puntos: 0 },
        "J": { img: "/assets/j.png", puntos: 0 },
        "Rojo": { img: "/assets/rojos.png", puntos: 0 },
        "Negro": { img: "/assets/negros.png", puntos: 0 }
    };
    const nombresCaras = Object.keys(caras);
    const tituloLanzador = document.getElementById('titulo-lanzador');
    const dadosContainer = document.getElementById('dados-container');
    const botonTirarDados = document.getElementById('boton-tirar-dados');
    const botonPlantarse = document.getElementById('boton-plantarse');
    const puntosTurnoActualElem = document.getElementById('puntos-turno-actual');
    const mensajeLanzador = document.getElementById('mensaje-lanzador');

    const NUM_DADOS = 5;
    let jugadorActualIndex = 0;
    let estadoDados = [];
    let puntosTurno = 0;

    function iniciarTurnoDados() {
        if (jugadores.length === 0) {
            tituloLanzador.textContent = "A√±ade jugadores primero";
            botonTirarDados.disabled = true;
            return;
        }
        const nombreJugador = jugadores[jugadorActualIndex];
        tituloLanzador.textContent = `Turno de ${nombreJugador}`;
        puntosTurno = 0;
        puntosTurnoActualElem.textContent = "0";
        mensajeLanzador.textContent = "";
        botonPlantarse.style.display = 'none';
        botonTirarDados.disabled = false;
        botonTirarDados.textContent = "¬°Tirar Dados!";
        
        botonTirarDados.classList.remove('btn-doblar');
        estadoDados = Array.from({ length: NUM_DADOS }, () => ({ estado: 'activo', valor: null }));
        renderizarDados();
    }

    function renderizarDados() {
        dadosContainer.innerHTML = '';
        estadoDados.forEach((dado, i) => {
            const img = document.createElement('img');
            img.dataset.index = i;
            if (dado.estado === 'girando') {
                img.src = '/assets/dado_girando.gif';
                img.alt = 'Dado girando';
            } else if (dado.valor) {
                img.src = caras[dado.valor].img;
                img.alt = `Resultado: ${dado.valor}`;
                if (dado.estado === 'apartado') {
                    img.classList.add('apartado');
                }
                if (dado.estado === 'tirado' && caras[dado.valor].puntos > 0) {
                    img.classList.add('puntua');
                    img.addEventListener('click', seleccionarDado);
                }
            } else {
                img.src = '/assets/inicio.png';
                img.alt = 'Dado inicial';
            }
            dadosContainer.appendChild(img);
        });
    }

    function tirarDados() {
        botonTirarDados.disabled = true;
        botonPlantarse.style.display = 'none';
        mensajeLanzador.textContent = "";
        botonTirarDados.classList.remove('btn-doblar');

        // Corregido: Poner a girar los dados activos (primera tirada) Y los que ya fueron tirados pero no apartados (siguientes tiradas).
        let dadosParaTirar = false;
        estadoDados.forEach(d => { 
            if (d.estado === 'activo' || d.estado === 'tirado') {
                d.estado = 'girando';
                dadosParaTirar = true;
            }
        });
        renderizarDados();

        setTimeout(() => {
            const tiradaActual = [];
            estadoDados.forEach(d => {
                if (d.estado === 'girando') {
                    d.valor = nombresCaras[Math.floor(Math.random() * nombresCaras.length)];
                    d.estado = 'tirado';
                    tiradaActual.push(d);
                }
            });

            // Analizar la tirada para combinaciones y puntos
            const conteo = tiradaActual.reduce((acc, dado) => {
                acc[dado.valor] = (acc[dado.valor] || 0) + 1;
                return acc;
            }, {});

            let puntosCombinacion = 0;
            let mensajeCombinacion = "";

            if (conteo['As'] >= 3) {
                puntosCombinacion = 1000;
                mensajeCombinacion = "¬°Tres Ases! +1000 puntos";
                tiradaActual.filter(d => d.valor === 'As').slice(0, 3).forEach(d => d.estado = 'apartado');
            } else if (conteo['K'] >= 3) {
                puntosCombinacion = 500;
                mensajeCombinacion = "¬°Tres K! +500 puntos";
                tiradaActual.filter(d => d.valor === 'K').slice(0, 3).forEach(d => d.estado = 'apartado');
            }

            if (puntosCombinacion > 0) {
                puntosTurno += puntosCombinacion;
                puntosTurnoActualElem.textContent = puntosTurno;
                mensajeLanzador.textContent = mensajeCombinacion;
                botonPlantarse.style.display = 'inline-block';
            }

            const hayPuntosIndividuales = tiradaActual.some(d => d.estado === 'tirado' && caras[d.valor].puntos > 0);
            const tiradaSinPuntos = puntosCombinacion === 0 && !hayPuntosIndividuales;

            if (tiradaSinPuntos) {
                mensajeLanzador.textContent = "¬°Mala suerte! No has sacado puntos. Turno perdido.";
                puntosTurno = 0;
                setTimeout(cambiarJugador, 2000);
            } else {
                botonTirarDados.disabled = false;
                botonTirarDados.textContent = "Volver a tirar";
            }
            renderizarDados();
            comprobarSiDobla();
        }, 1500); // Animaci√≥n m√°s corta
    }

    function seleccionarDado(e) {
        const index = parseInt(e.target.dataset.index);
        const dado = estadoDados[index];
        if (dado.estado !== 'tirado' || caras[dado.valor].puntos === 0) return;

        dado.estado = 'apartado';
        puntosTurno += caras[dado.valor].puntos;
        puntosTurnoActualElem.textContent = puntosTurno;
        botonPlantarse.style.display = 'inline-block';
        renderizarDados();
        comprobarSiDobla();
    }

    function comprobarSiDobla() {
        const todosApartados = estadoDados.every(d => d.estado === 'apartado');
        if (todosApartados) {
            mensajeLanzador.textContent = "¬°Has puntuado con los 5 dados!";
            botonTirarDados.textContent = "¬°DOBLARSE! (Tirar 5 de nuevo)";
            botonTirarDados.classList.add('btn-doblar');
            // Reiniciamos el estado de los dados para la siguiente tirada
            estadoDados = Array.from({ length: NUM_DADOS }, () => ({ estado: 'activo', valor: null }));
            // ¬°NUEVO! Mostramos los dados como "reseteados" para que sea m√°s claro
            renderizarDados();
        }
    }

    function cambiarJugador() {
        jugadorActualIndex = (jugadorActualIndex + 1) % jugadores.length;
        iniciarTurnoDados();
    };

    botonTirarDados.addEventListener('click', tirarDados);
    botonPlantarse.addEventListener('click', () => {
        const nombreJugador = jugadores[jugadorActualIndex];
        window.actualizarPuntosPorVoz(nombreJugador, puntosTurno); // Reutilizamos la funci√≥n de voz
        modalDados.style.display = 'none'; // Cierra el modal al plantarse
        cambiarJugador();
    });

  });
</script>

</body>
</html>